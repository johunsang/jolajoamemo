name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 0.1.0)'
        required: true
        default: '0.1.0'

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Changelog
        id: changelog
        shell: bash
        run: |
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 2>/dev/null || echo "")..HEAD 2>/dev/null | head -20 >> $GITHUB_OUTPUT || echo "- Initial release" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install frontend dependencies
        run: npm install

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__
          releaseName: 'JolaJoa Memo v__VERSION__'
          releaseBody: |
            # JolaJoa Memo v__VERSION__

            ## ğŸ“ What's New / ë³€ê²½ ì‚¬í•­
            ${{ steps.changelog.outputs.CHANGELOG }}

            ---

            ## ğŸ‡°ğŸ‡· í•œêµ­ì–´

            **AIê°€ ì•Œì•„ì„œ ì •ë¦¬í•˜ëŠ” ìŠ¤ë§ˆíŠ¸ ë©”ëª¨ì¥**

            ë©”ëª¨ë§Œ ë˜ì§€ë©´ AIê°€ ìë™ìœ¼ë¡œ ì œëª©, ì¹´í…Œê³ ë¦¬, íƒœê·¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            ìì—°ì–´ë¡œ ì§ˆë¬¸í•˜ë©´ AIê°€ ë©”ëª¨ë¥¼ ê²€ìƒ‰í•´ì„œ ë‹µë³€í•©ë‹ˆë‹¤.

            ### ì£¼ìš” ê¸°ëŠ¥
            - âœ¨ **AI ìë™ ì •ë¦¬** - Gemini AIê°€ ë©”ëª¨ë¥¼ ë¶„ì„í•´ ìë™ ë¶„ë¥˜
            - ğŸ” **ìì—°ì–´ ê²€ìƒ‰** - "ì§€ë‚œì£¼ íšŒì˜ ë‚´ìš©ì´ ë­ì˜€ì§€?" ì²˜ëŸ¼ ì§ˆë¬¸
            - ğŸ’¾ **ì‹¤ì‹œê°„ ìë™ì €ì¥** - í¸ì§‘ ì¤‘ ìë™ ì €ì¥ (ì €ì¥ ë²„íŠ¼ ë¶ˆí•„ìš”)
            - ğŸ—‚ï¸ **ë“œë˜ê·¸ ì•¤ ë“œë¡­** - ë©”ëª¨ë¥¼ ë“œë˜ê·¸í•´ì„œ ì¹´í…Œê³ ë¦¬ ì´ë™
            - ğŸŒ™ **ë‹¤í¬ ëª¨ë“œ** - ëˆˆì˜ í”¼ë¡œë¥¼ ì¤„ì´ëŠ” ë‹¤í¬ í…Œë§ˆ
            - ğŸŒ **ë‹¤êµ­ì–´ ì§€ì›** - í•œêµ­ì–´, English, æ—¥æœ¬èª, ä¸­æ–‡, FranÃ§ais

            ### ìš”êµ¬ì‚¬í•­
            - [Gemini API Key](https://aistudio.google.com/apikey) (ë¬´ë£Œ)

            ---

            ## ğŸ‡ºğŸ‡¸ English

            **AI-Powered Smart Notepad**

            Just paste your notes and AI automatically generates titles, categories, and tags.
            Ask questions in natural language and AI searches your notes to answer.

            ### Key Features
            - âœ¨ **AI Auto-Organization** - Gemini AI analyzes and categorizes your notes
            - ğŸ” **Natural Language Search** - Ask "What was discussed in last week's meeting?"
            - ğŸ’¾ **Real-time Auto-Save** - Saves automatically while editing
            - ğŸ—‚ï¸ **Drag & Drop** - Move notes between categories by dragging
            - ğŸŒ™ **Dark Mode** - Eye-friendly dark theme
            - ğŸŒ **Multilingual** - Korean, English, Japanese, Chinese, French

            ### Requirements
            - [Gemini API Key](https://aistudio.google.com/apikey) (Free)

            ---

            ## ğŸ“¥ Downloads

            | Platform | File |
            |----------|------|
            | **Windows** | `JolaJoa.Memo_x.x.x_x64-setup.exe` |
            | **macOS (Apple Silicon)** | `JolaJoa.Memo_x.x.x_aarch64.dmg` |
            | **macOS (Intel)** | `JolaJoa.Memo_x.x.x_x64.dmg` |

            ---

            ## ğŸ“Š API Usage & Cost

            | Model | Input | Output |
            |-------|-------|--------|
            | Gemini 2.0 Flash | $0.10 / 1M tokens | $0.40 / 1M tokens |

            **ì˜ˆì‹œ / Example:**
            - ë©”ëª¨ ì €ì¥ 1íšŒ: ~$0.0005 (ì•½ 0.5ì›)
            - í•˜ë£¨ 100íšŒ ì‚¬ìš©: ~$0.15 (ì•½ 200ì›)

          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}
